
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Líder - Gestão Industrial 4.0</title>
    
    <!-- Identidade Visual - Favicon -->
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- PDF & Data Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK (Compatibility Version 10.12.0) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .matrix-cell { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .matrix-cell:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .status-pill {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            padding: 4px 12px; border-radius: 9999px; letter-spacing: 0.025em;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        input, select, textarea {
            background-color: #f8fafc !important;
            color: #0f172a !important;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .matrix-table th { border: 1px solid #e2e8f0; }
        .matrix-table td { border: 1px solid #f1f5f9; }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); opacity: 1; }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); opacity: 0.6; }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); opacity: 1; }
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite ease-in-out;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Cell, PieChart, Pie, Legend, AreaChart, Area } = Recharts;

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8vZ1jZrE9wpo_YM3rk2BhMiRSfYsqss8",
            authDomain: "projeto-sistema-lider.firebaseapp.com",
            projectId: "projeto-sistema-lider",
            storageBucket: "projeto-sistema-lider.firebasestorage.app",
            messagingSenderId: "831955890134",
            appId: "1:831955890134:web:b399188528357f7540be77",
            measurementId: "G-0QEGX479FK"
        };

        // Inicialização do Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- DADOS INICIAIS ---
        const TOPICS_LIST = ['SAP', 'EHS&S', 'PLANO DE PRODUÇÃO', 'QUALIDADE'];
        const ROLE_OPTIONS = ['Operador III', 'Operador II', 'Operador I', 'Auxiliar de Produção'];

        const PREREQUISITE_RULES = {
            'Preenchimento de OP': { 'Operador III': 4, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 3 },
            'Apontamento de OP': { 'Operador III': 4, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 1 },
            'Encerramento de OP': { 'Operador III': 4, 'Operador II': 3, 'Operador I': 2, 'Auxiliar de Produção': 1 },
            'Abertura de notas de manutenção': { 'Operador III': 4, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 1 },
            'Planejar e realizar DDS': { 'Operador III': 3, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 2 },
            'Comportamento seguro (SSMA)': { 'Operador III': 3, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 3 },
            'Conhecer as FISPQS': { 'Operador III': 3, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 3 },
            'Organização diária do time': { 'Operador III': 4, 'Operador II': 3, 'Operador I': 2, 'Auxiliar de Produção': 1 },
            'Atualizar cronograma': { 'Operador III': 3, 'Operador II': 2, 'Operador I': 1, 'Auxiliar de Produção': 0 },
            'Conhecimento no cronograma': { 'Operador III': 3, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 1 },
            'Participação em Shop Floor': { 'Operador III': 3, 'Operador II': 3, 'Operador I': 3, 'Auxiliar de Produção': 1 }
        };

        // --- COMPONENTES ---

        const LogoIcon = () => (
            <svg viewBox="0 0 200 110" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                <path d="M75 25 L105 25 L125 55 L105 85 L75 85 L55 55 Z" stroke="#0f172a" strokeWidth="6" strokeLinejoin="round" />
                <path d="M78 35 L100 35 L115 55 L100 75 L78 75 L63 55 Z" stroke="#0f172a" strokeWidth="1" strokeLinejoin="round" opacity="0.3" />
                <path d="M95 25 L125 25 L145 55 L125 85 L95 85 L75 55 Z" stroke="#0f172a" strokeWidth="6" strokeLinejoin="round" />
                <path d="M98 35 L120 35 L135 55 L120 75 L98 75 L83 55 Z" stroke="#0f172a" strokeWidth="1" strokeLinejoin="round" opacity="0.3" />
                <circle cx="100" cy="25" r="2" fill="#0f172a" />
                <circle cx="100" cy="85" r="2" fill="#0f172a" />
                <circle cx="75" cy="55" r="2" fill="#0f172a" />
                <circle cx="125" cy="55" r="2" fill="#0f172a" />
                <path d="M94 50 L106 50 L112 55 L106 60 L94 60 L88 55 Z" fill="#f97316" />
            </svg>
        );

        const AuthView = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6">
                    <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden p-10 animate-fade">
                        <div className="flex flex-col items-center mb-8">
                            <div className="w-20 h-20 bg-slate-50 rounded-2xl p-2 mb-4">
                                <LogoIcon />
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">
                                {isLogin ? 'Entrar no Sistema' : 'Criar Nova Conta'}
                            </h2>
                            <p className="text-slate-500 text-sm font-medium mt-1">Gerencie seu time com o Método Sistema Líder</p>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-xs font-bold mb-6 flex items-center gap-2">
                                <i data-lucide="alert-circle" style={{width: 16}}></i> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="space-y-1">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">E-mail</label>
                                <input type="email" required className="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all font-medium" 
                                    placeholder="exemplo@lider.com" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Senha</label>
                                <input type="password" required className="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all font-medium" 
                                    placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full py-4 bg-blue-600 text-white rounded-xl font-black uppercase tracking-widest shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all mt-4">
                                {isLogin ? 'Fazer Login' : 'Finalizar Cadastro'}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <button onClick={() => setIsLogin(!isLogin)} className="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-widest transition-colors">
                                {isLogin ? 'Não tem conta? Cadastre-se' : 'Já possui conta? Faça Login'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ matrixData, pdis, meetings, skills, procedures, trainingRecords }) => {
            useEffect(() => { lucide.createIcons(); }, []);

            const topicScoresData = useMemo(() => {
                const topics = [...new Set(skills.map(s => s.topic))];
                return topics.map(topic => {
                    const topicSkills = skills.filter(s => s.topic === topic);
                    let sumR = 0;
                    let sumP = 0;
                    matrixData.forEach(emp => {
                        topicSkills.forEach(s => {
                            sumR += (emp.skills[s.name]?.r || 0);
                            sumP += (emp.skills[s.name]?.p || 0);
                        });
                    });
                    const score = sumP > 0 ? Math.round((sumR / sumP) * 100) : 0;
                    return { name: topic, score, r: sumR, p: sumP };
                });
            }, [matrixData, skills]);

            const skillLevelDist = useMemo(() => {
                const dist = [
                    { name: 'Nível 1', value: 0, color: '#ffedd5' },
                    { name: 'Nível 2', value: 0, color: '#bfdbfe' },
                    { name: 'Nível 3', value: 0, color: '#60a5fa' },
                    { name: 'Nível 4', value: 0, color: '#2563eb' }
                ];
                matrixData.forEach(emp => {
                    Object.values(emp.skills).forEach(s => {
                        if (s.r >= 1 && s.r <= 4) dist[s.r - 1].value++;
                    });
                });
                return dist.filter(d => d.value > 0);
            }, [matrixData]);

            const pdiProgressData = useMemo(() => {
                let totalGoals = 0;
                let completedGoals = 0;
                pdis.forEach(p => {
                    (p.goals || []).forEach(g => {
                        totalGoals++;
                        if (g.completed) completedGoals++;
                    });
                });
                return [
                    { name: 'Concluídas', value: completedGoals },
                    { name: 'Pendentes', value: totalGoals - completedGoals }
                ];
            }, [pdis]);

            const trainingCompliance = useMemo(() => {
                let mandatoryCount = 0;
                let completedCount = 0;
                matrixData.forEach(emp => {
                    procedures.forEach(p => {
                        const isMandatory = (p.roles || []).map(r => r.toUpperCase()).includes(emp.role.trim().toUpperCase());
                        if (isMandatory) {
                            mandatoryCount++;
                            const rec = trainingRecords[`${emp.name}-${p.code}`];
                            if (rec?.status === 'Concluído') completedCount++;
                        }
                    });
                });
                return mandatoryCount > 0 ? Math.round((completedCount / mandatoryCount) * 100) : 0;
            }, [matrixData, procedures, trainingRecords]);

            const totalGaps = useMemo(() => {
                let count = 0;
                matrixData.forEach(emp => {
                    Object.values(emp.skills).forEach(s => { if (s.r < s.p) count++; });
                });
                return count;
            }, [matrixData]);

            return (
                <div className="animate-fade">
                    <header className="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h2 className="text-3xl font-black text-slate-800 tracking-tight">Painel de Controle Estratégico</h2>
                            <p className="text-slate-500 font-medium">Visão consolidada do time, competências e conformidade.</p>
                        </div>
                    </header>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition-all">
                            <div className="flex items-center justify-between mb-4">
                                <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                                    <i data-lucide="users" style={{width: 20}}></i>
                                </div>
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Equipe</span>
                            </div>
                            <p className="text-4xl font-black text-slate-800 tracking-tighter">{matrixData.length}</p>
                            <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-tighter">Colaboradores Ativos</p>
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition-all">
                            <div className="flex items-center justify-between mb-4">
                                <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center">
                                    <i data-lucide="zap" style={{width: 20}}></i>
                                </div>
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Habilidades</span>
                            </div>
                            <p className="text-4xl font-black text-amber-600 tracking-tighter">{totalGaps}</p>
                            <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-tighter">GAPs de Skill Detectados</p>
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition-all">
                            <div className="flex items-center justify-between mb-4">
                                <div className="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" style={{width: 20}}></i>
                                </div>
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Treinamento</span>
                            </div>
                            <p className="text-4xl font-black text-emerald-600 tracking-tighter">{trainingCompliance}%</p>
                            <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-tighter">Conformidade Legal (POP)</p>
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition-all">
                            <div className="flex items-center justify-between mb-4">
                                <div className="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center">
                                    <i data-lucide="target" style={{width: 20}}></i>
                                </div>
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">PDI Ativo</span>
                            </div>
                            <p className="text-4xl font-black text-purple-600 tracking-tighter">{pdis.length}</p>
                            <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-tighter">Planos em Desenvolvimento</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div className="lg:col-span-2 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                            <div className="flex items-center justify-between mb-8">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">Aderência por Categoria de Skill (%)</h3>
                                <div className="flex gap-2">
                                    <div className="flex items-center gap-1"><div className="w-2 h-2 bg-blue-600 rounded-full"></div><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Real</span></div>
                                </div>
                            </div>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={topicScoresData} layout="vertical">
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke="#f1f5f9" />
                                        <XAxis type="number" domain={[0, 100]} hide />
                                        <YAxis dataKey="name" type="category" axisLine={false} tickLine={false} tick={{fontSize: 9, fontWeight: 900, fill: '#64748b'}} width={100} />
                                        <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                        <Bar dataKey="score" radius={[0, 8, 8, 0]} barSize={25}>
                                            {topicScoresData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.score > 80 ? '#10b981' : entry.score > 50 ? '#3b82f6' : '#f59e0b'} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 text-center">Distribuição de Níveis de Proficiência</h3>
                            <div className="h-56 flex-1">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={skillLevelDist} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                            {skillLevelDist.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Pie>
                                        <Tooltip />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="mt-4 grid grid-cols-2 gap-2">
                                {skillLevelDist.map((d, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full" style={{backgroundColor: d.color}}></div>
                                        <span className="text-[9px] font-bold text-slate-500 uppercase truncate">{d.name} ({d.value})</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl">
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">Progresso de Metas PDI</h3>
                                <i data-lucide="trending-up" className="text-blue-500" style={{width: 16}}></i>
                            </div>
                            <div className="space-y-6">
                                {pdiProgressData[0].value + pdiProgressData[1].value > 0 ? (
                                    <>
                                        <div>
                                            <div className="flex justify-between items-end mb-2">
                                                <span className="text-[10px] font-black uppercase text-slate-500 tracking-widest">Taxa de Conclusão Global</span>
                                                <span className="text-2xl font-black text-blue-400">{Math.round((pdiProgressData[0].value / (pdiProgressData[0].value + pdiProgressData[1].value)) * 100)}%</span>
                                            </div>
                                            <div className="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                                                <div className="h-full bg-blue-500 transition-all duration-1000" style={{width: `${(pdiProgressData[0].value / (pdiProgressData[0].value + pdiProgressData[1].value)) * 100}%`}}></div>
                                            </div>
                                        </div>
                                        <div className="flex justify-around py-4 border-t border-slate-800">
                                            <div className="text-center">
                                                <p className="text-sm font-black text-white">{pdiProgressData[0].value}</p>
                                                <p className="text-[8px] font-black uppercase text-slate-500 tracking-widest">Concluídas</p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-sm font-black text-white">{pdiProgressData[1].value}</p>
                                                <p className="text-[8px] font-black uppercase text-slate-500 tracking-widest">Em Aberto</p>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center py-10 opacity-30">Sem metas registradas</div>
                                )}
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Últimas Reuniões 1:1</h3>
                            <div className="space-y-4">
                                {meetings.slice(-3).reverse().map((m, i) => (
                                    <div key={i} className="flex items-start gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                                        <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-blue-600 shadow-sm font-black text-xs">
                                            {m.employee.charAt(0)}
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-xs font-black text-slate-800">{m.employee}</p>
                                            <p className="text-[9px] text-slate-400 truncate max-w-[200px]">{m.summary}</p>
                                        </div>
                                        <span className="text-[8px] font-black text-slate-300 uppercase">{m.date}</span>
                                    </div>
                                ))}
                                {meetings.length === 0 && <div className="text-center py-8 text-[10px] font-black text-slate-300 uppercase tracking-widest">Sem feedbacks recentes</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const OperatorRegistrationView = ({ matrixData, skills, user }) => {
            const [formData, setFormData] = useState({ name: '', role: '' });
            useEffect(() => { lucide.createIcons(); }, []);

            const handleAddOperator = async (e) => {
                e.preventDefault();
                const trimmedName = formData.name.trim();
                const trimmedRole = formData.role.trim();
                if (!trimmedName || !trimmedRole) return;

                const skillsMap = skills.reduce((acc, s) => {
                    const skillRule = PREREQUISITE_RULES[s.name];
                    const defaultP = skillRule ? (skillRule[trimmedRole] ?? 3) : 3;
                    return { ...acc, [s.name]: { p: defaultP, r: 0 } };
                }, {});

                try {
                    await db.collection('operators').add({
                        name: trimmedName,
                        role: trimmedRole,
                        skills: skillsMap,
                        uid: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setFormData({ name: '', role: '' });
                    alert('Colaborador registrado com sucesso.');
                } catch (error) {
                    console.error("Erro ao adicionar operador:", error);
                }
            };

            return (
                <div className="animate-fade">
                    <header className="mb-8">
                        <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">Cadastro de Novo Colaborador</h2>
                    </header>
                    <form onSubmit={handleAddOperator} className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-xl mb-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="flex flex-col gap-2">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nome Completo</label>
                            <input required placeholder="Ex: João Silva" className="px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 font-medium" 
                                value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cargo / Função</label>
                            <input required placeholder="Ex: Operador III" className="px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 font-medium" 
                                value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} />
                        </div>
                        <button type="submit" className="md:col-span-2 py-4 bg-blue-600 text-white rounded-xl font-black uppercase tracking-widest shadow-lg hover:bg-blue-700 transition-all">
                            Salvar Colaborador
                        </button>
                    </form>
                    <div className="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-slate-900 text-white">
                                <tr>
                                    <th className="px-8 py-4 text-left text-[10px] uppercase font-black tracking-widest">Colaborador</th>
                                    <th className="px-8 py-4 text-left text-[10px] uppercase font-black tracking-widest">Cargo</th>
                                    <th className="px-8 py-4 text-right text-[10px] uppercase font-black tracking-widest">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {matrixData.map((op) => (
                                    <tr key={op.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-8 py-4 font-bold text-slate-700">{op.name}</td>
                                        <td className="px-8 py-4 text-slate-500 text-sm">{op.role}</td>
                                        <td className="px-8 py-4 text-right">
                                            <button onClick={() => db.collection('operators').doc(op.id).delete()} className="text-red-300 hover:text-red-600 p-2">
                                                <i data-lucide="trash-2" style={{width: 18}}></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const SkillMatrixView = ({ data, skills, user }) => {
            const [editing, setEditing] = useState(null);
            const [showAddSkill, setShowAddSkill] = useState(false);
            const [newSkillName, setNewSkillName] = useState('');
            const [newSkillTopic, setNewSkillTopic] = useState('SAP');
            const [customTopic, setCustomTopic] = useState('');
            const [rolePrereqs, setRolePrereqs] = useState({});

            const uniqueRoles = useMemo(() => [...new Set(data.map(op => op.role))].sort(), [data]);

            useEffect(() => {
                const initial = {};
                uniqueRoles.forEach(role => {
                    initial[role] = 3;
                });
                setRolePrereqs(initial);
            }, [uniqueRoles]);

            useEffect(() => { lucide.createIcons(); }, [editing, data, skills, showAddSkill, newSkillTopic, uniqueRoles]);

            const groupedSkills = useMemo(() => {
                const groups = {};
                skills.forEach(s => {
                    if (!groups[s.topic]) groups[s.topic] = [];
                    groups[s.topic].push(s);
                });
                return groups;
            }, [skills]);

            const uniqueTopics = Object.keys(groupedSkills);
            const orderedSkills = uniqueTopics.flatMap(t => groupedSkills[t]);

            const updateValue = async (opId, skillKey, type, val) => {
                const numeric = Math.min(4, Math.max(0, parseInt(val) || 0));
                const op = data.find(o => o.id === opId);
                const updatedSkills = { ...op.skills };
                if (!updatedSkills[skillKey]) updatedSkills[skillKey] = { p: 3, r: 0 };
                updatedSkills[skillKey][type] = numeric;
                await db.collection('operators').doc(opId).update({ skills: updatedSkills });
                setEditing(null);
            };

            const handleAddSkill = async (e) => {
                e.preventDefault();
                if (!newSkillName.trim()) return;
                
                const finalTopic = newSkillTopic === 'OUTROS' ? customTopic.trim() : newSkillTopic;
                if (!finalTopic) return;

                await db.collection('skills_config').add({
                    name: newSkillName.trim(),
                    topic: finalTopic,
                    uid: user.uid,
                    rolePrereqs: rolePrereqs
                });
                
                const snapshot = await db.collection('operators').where('uid', '==', user.uid).get();
                const batch = db.batch();
                snapshot.forEach(doc => {
                    const opRole = doc.data().role;
                    const pValue = rolePrereqs[opRole] !== undefined ? rolePrereqs[opRole] : 3;
                    batch.update(doc.ref, { [`skills.${newSkillName.trim()}`]: { p: pValue, r: 0 } });
                });
                await batch.commit();
                
                setShowAddSkill(false);
                setNewSkillName('');
                setCustomTopic('');
                setNewSkillTopic('SAP');
            };

            const handleDeleteSkill = async (skillId, skillName) => {
                if (!confirm(`Excluir a habilidade "${skillName}"? Isso removerá os dados vinculados a todos os colaboradores.`)) return;
                await db.collection('skills_config').doc(skillId).delete();
                
                const snapshot = await db.collection('operators').where('uid', '==', user.uid).get();
                const batch = db.batch();
                snapshot.forEach(doc => {
                    const opData = doc.data();
                    if (opData.skills && opData.skills[skillName]) {
                        const updated = { ...opData.skills };
                        delete updated[skillName];
                        batch.update(doc.ref, { skills: updated });
                    }
                });
                await batch.commit();
            };

            const handleDeleteTopic = async (topicName) => {
                if (!confirm(`Excluir o tópico "${topicName}" e TODAS as suas habilidades associadas?`)) return;
                const topicSkills = skills.filter(s => s.topic === topicName);
                const batch = db.batch();
                topicSkills.forEach(s => batch.delete(db.collection('skills_config').doc(s.id)));
                
                const snapshot = await db.collection('operators').where('uid', '==', user.uid).get();
                snapshot.forEach(doc => {
                    const opData = doc.data();
                    const updated = { ...opData.skills };
                    let changed = false;
                    topicSkills.forEach(s => {
                        if (updated[s.name]) {
                            delete updated[s.name];
                            changed = true;
                        }
                    });
                    if (changed) batch.update(doc.ref, { skills: updated });
                });
                await batch.commit();
            };

            const getLevelColor = (val) => {
                if (val >= 4) return 'bg-blue-600 text-white';
                if (val >= 3) return 'bg-blue-400 text-white';
                if (val >= 2) return 'bg-blue-200 text-blue-900';
                if (val >= 1) return 'bg-orange-100 text-orange-800';
                return 'bg-slate-100 text-slate-400';
            };

            return (
                <div className="animate-fade">
                    <div className="flex justify-between items-center mb-10">
                        <h2 className="text-2xl font-black text-slate-800">Matriz de Habilidades</h2>
                        <button onClick={() => setShowAddSkill(!showAddSkill)} className="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black uppercase text-xs">Nova Habilidade</button>
                    </div>

                    {showAddSkill && (
                        <form onSubmit={handleAddSkill} className="bg-white p-8 rounded-[2rem] border shadow-xl mb-8 space-y-6 animate-fade">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nome da Habilidade</label>
                                    <input required placeholder="Ex: Operação de Caldeira" className="w-full px-4 py-3 rounded-xl border bg-slate-50 font-medium" value={newSkillName} onChange={e => setNewSkillName(e.target.value)} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Tópicos</label>
                                    <select className="w-full px-4 py-3 rounded-xl border bg-slate-50 font-medium" value={newSkillTopic} onChange={e => setNewSkillTopic(e.target.value)}>
                                        {TOPICS_LIST.map(t => <option key={t} value={t}>{t}</option>)}
                                        <option value="OUTROS">Outros...</option>
                                    </select>
                                </div>
                            </div>
                            
                            {newSkillTopic === 'OUTROS' && (
                                <div className="space-y-1 animate-fade">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Especifique o Tópico</label>
                                    <input required placeholder="Digite o novo tópico" className="w-full px-4 py-3 rounded-xl border bg-slate-50 font-medium" value={customTopic} onChange={e => setCustomTopic(e.target.value)} />
                                </div>
                            )}

                            <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                <h3 className="text-[11px] font-black text-slate-600 uppercase tracking-widest mb-4">Nível P (Pré-requisito por Cargo)</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {uniqueRoles.length > 0 ? (
                                        uniqueRoles.map(role => (
                                            <div key={role} className="space-y-1">
                                                <label className="text-[9px] font-bold text-slate-500 uppercase tracking-wider truncate block" title={role}>{role}</label>
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    max="4" 
                                                    required 
                                                    className="w-full px-3 py-2 rounded-lg border bg-white text-sm font-medium" 
                                                    value={rolePrereqs[role] !== undefined ? rolePrereqs[role] : 3} 
                                                    onChange={e => setRolePrereqs({...rolePrereqs, [role]: parseInt(e.target.value)})} 
                                                />
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-[10px] text-slate-400 italic">Cadastre colaboradores para atribuir níveis P por cargo.</p>
                                    )}
                                </div>
                            </div>
                            
                            <button className="w-full py-4 bg-slate-900 text-white rounded-xl font-black uppercase tracking-widest shadow-lg">Criar Habilidade</button>
                        </form>
                    )}

                    <div className="bg-white rounded-[2rem] border shadow-xl overflow-hidden">
                        <div className="overflow-x-auto overflow-y-auto max-h-[700px] custom-scrollbar">
                            <table className="min-w-full matrix-table min-w-max">
                                <thead>
                                    <tr className="bg-slate-900 text-white">
                                        <th rowSpan="3" className="px-8 py-4 text-left font-black text-xs uppercase bg-slate-900 sticky left-0 z-40 border-r border-slate-700">Colaborador</th>
                                        {uniqueTopics.map(topic => (
                                            <th key={topic} colSpan={groupedSkills[topic].length * 2} className="px-4 py-3 text-center text-[11px] font-black uppercase border-l-2 border-slate-700">
                                                <div className="flex items-center justify-center gap-2">
                                                    {topic}
                                                    <button onClick={() => handleDeleteTopic(topic)} className="text-white/30 hover:text-red-400 transition-colors">
                                                        <i data-lucide="trash-2" style={{width: 14}}></i>
                                                    </button>
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                    <tr className="bg-blue-50 text-slate-800">
                                        {orderedSkills.map(skill => (
                                            <th key={skill.id || skill.name} colSpan="2" className="px-4 py-4 text-center text-[9px] font-bold border-l border-slate-200 min-w-[120px]">
                                                <div className="flex flex-col items-center gap-1">
                                                    {skill.name}
                                                    <button onClick={() => handleDeleteSkill(skill.id, skill.name)} className="text-slate-300 hover:text-red-500 transition-colors">
                                                        <i data-lucide="x-circle" style={{width: 12}}></i>
                                                    </button>
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                    <tr className="bg-blue-100/30 text-slate-500 font-black text-[8px] uppercase tracking-tighter">
                                        {orderedSkills.map(skill => (
                                            <React.Fragment key={`pr-labels-${skill.id || skill.name}`}>
                                                <th className="px-1 py-1 text-center border-l border-slate-100">P</th>
                                                <th className="px-1 py-1 text-center">R</th>
                                            </React.Fragment>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((emp) => (
                                        <tr key={emp.id} className="hover:bg-slate-50">
                                            <td className="px-8 py-4 font-bold text-slate-700 sticky left-0 bg-white z-20 border-r-2 border-slate-100 shadow-sm">{emp.name}</td>
                                            {orderedSkills.map(skill => {
                                                const p = emp.skills[skill.name]?.p || 0;
                                                const r = emp.skills[skill.name]?.r || 0;
                                                return (
                                                    <React.Fragment key={`${skill.id || skill.name}-${emp.id}`}>
                                                        <td className="p-2 border-l border-slate-50">
                                                            <div onClick={() => setEditing({opId: emp.id, s: skill.name, type:'p'})} className={`w-9 h-9 mx-auto rounded-lg flex items-center justify-center font-black text-[10px] matrix-cell ${getLevelColor(p)}`}>
                                                                {editing?.opId === emp.id && editing?.s === skill.name && editing?.type === 'p' ? (
                                                                    <input autoFocus className="w-full h-full bg-slate-100 text-center" onBlur={(e) => updateValue(emp.id, skill.name, 'p', e.target.value)} />
                                                                ) : p}
                                                            </div>
                                                        </td>
                                                        <td className="p-2 relative">
                                                            <div onClick={() => setEditing({opId: emp.id, s: skill.name, type:'r'})} className={`w-9 h-9 mx-auto rounded-lg flex items-center justify-center font-black text-[10px] matrix-cell ${getLevelColor(r)} ${r < p ? 'ring-2 ring-red-400' : ''}`}>
                                                                {editing?.opId === emp.id && editing?.s === skill.name && editing?.type === 'r' ? (
                                                                    <input autoFocus className="w-full h-full bg-slate-100 text-center" onBlur={(e) => updateValue(emp.id, skill.name, 'r', e.target.value)} />
                                                                ) : r}
                                                            </div>
                                                            {r < p && <div className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>}
                                                        </td>
                                                    </React.Fragment>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const TrainingMatrixView = ({ matrixData, procedures, trainingRecords, user }) => {
            const [viewMode, setViewMode] = useState('roles');
            const [showAddForm, setShowAddForm] = useState(false);
            const [newPop, setNewPop] = useState({ code: '', title: '', date: '', validity: 12 });

            useEffect(() => { lucide.createIcons(); }, [viewMode, procedures, showAddForm]);

            const availableRoles = useMemo(() => {
                const rolesInMatrix = matrixData.map(emp => emp.role.trim().toUpperCase()).filter(Boolean);
                return [...new Set(rolesInMatrix)].sort();
            }, [matrixData]);

            const handleAddProcedure = async (e) => {
                e.preventDefault();
                await db.collection('procedures').add({
                    code: newPop.code, title: newPop.title, homologationDate: newPop.date, validityMonths: newPop.validity, roles: [], uid: user.uid
                });
                setShowAddForm(false);
                setNewPop({ code: '', title: '', date: '', validity: 12 });
            };

            const toggleRole = async (codeId, role) => {
                const proc = procedures.find(p => p.id === codeId);
                const roleUpper = role.toUpperCase();
                const currentRoles = (proc.roles || []).map(r => r.toUpperCase());
                const newRoles = currentRoles.includes(roleUpper) 
                    ? currentRoles.filter(r => r !== roleUpper) 
                    : [...currentRoles, roleUpper];
                await db.collection('procedures').doc(codeId).update({ roles: newRoles });
            };

            const updateStatus = async (empName, popCode, status) => {
                const key = `${user.uid}_${empName}_${popCode}`;
                await db.collection('training_records').doc(key).set({
                    status, empName, popCode, uid: user.uid, date: new Date().toISOString().split('T')[0]
                });
            };

            const isExpired = useCallback((hDate, val) => {
                if (!hDate || !val) return false;
                const date = new Date(hDate);
                date.setMonth(date.getMonth() + parseInt(val));
                return new Date() > date;
            }, []);

            const getStatusColor = (status, expired = false) => {
                if (expired || status === 'Atrasado') return 'text-red-600 bg-red-50 border-red-100 animate-pulse-red';
                switch(status) {
                    case 'Concluído': return 'text-emerald-600 bg-emerald-50 border-emerald-100';
                    case 'Pendente': return 'text-amber-600 bg-amber-50 border-amber-100';
                    default: return 'text-slate-400 bg-slate-50 border-slate-100';
                }
            };

            return (
                <div className="animate-fade">
                    <header className="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">Matriz de Treinamento</h2>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={() => setShowAddForm(!showAddForm)} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-black uppercase text-xs shadow-lg shadow-blue-200">Novo POP</button>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                <button 
                                    onClick={() => setViewMode('roles')} 
                                    className={`px-4 py-2 rounded-lg font-black uppercase text-[10px] transition-all ${viewMode === 'roles' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`}>
                                    Visão Cargo
                                </button>
                                <button 
                                    onClick={() => setViewMode('employees')} 
                                    className={`px-4 py-2 rounded-lg font-black uppercase text-[10px] transition-all ${viewMode === 'employees' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`}>
                                    Visão Colaborador
                                </button>
                            </div>
                        </div>
                    </header>

                    {showAddForm && (
                        <form onSubmit={handleAddProcedure} className="bg-white p-8 rounded-[2rem] border shadow-xl mb-10 space-y-6 animate-fade">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Cadastrar Novo Procedimento Operacional Padrão (POP)</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Código</label>
                                    <input required placeholder="Ex: POP-001" className="w-full p-3 border rounded-xl bg-slate-50" value={newPop.code} onChange={e => setNewPop({...newPop, code: e.target.value})} />
                                </div>
                                <div className="md:col-span-2 space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Título do Procedimento</label>
                                    <input required placeholder="Ex: Higienização de Reatores" className="w-full p-3 border rounded-xl bg-slate-50" value={newPop.title} onChange={e => setNewPop({...newPop, title: e.target.value})} />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Prazo de Validade (meses)</label>
                                    <input type="number" min="1" required className="w-full p-3 border rounded-xl bg-slate-50" value={newPop.validity} onChange={e => setNewPop({...newPop, validity: e.target.value})} />
                                </div>
                                <div className="md:col-span-4 space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Data de Homologação</label>
                                    <input type="date" required className="w-full p-3 border rounded-xl bg-slate-50" value={newPop.date} onChange={e => setNewPop({...newPop, date: e.target.value})} />
                                </div>
                            </div>
                            <button className="w-full py-4 bg-slate-900 text-white rounded-xl font-black uppercase tracking-widest">Adicionar POP ao Sistema</button>
                        </form>
                    )}

                    <div className="bg-white border rounded-[2rem] overflow-x-auto shadow-sm custom-scrollbar">
                        <table className="w-full text-left">
                            <thead className="bg-slate-900 text-white text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th className="p-6 sticky left-0 bg-slate-900 z-10 min-w-[250px]">{viewMode === 'roles' ? 'Procedimento / POP' : 'Colaborador / Cargo'}</th>
                                    {viewMode === 'roles' ? 
                                        availableRoles.map(r => <th key={r} className="p-4 border-l border-slate-800 text-center">{r}</th>) : 
                                        procedures.map(p => <th key={p.code} className="p-4 border-l border-slate-800 text-center">{p.code}</th>)
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                {viewMode === 'roles' ? (
                                    procedures.map(p => {
                                        const expired = isExpired(p.homologationDate, p.validityMonths);
                                        return (
                                            <tr key={p.id} className={`border-t hover:bg-slate-50 ${expired ? 'bg-red-50/30' : ''}`}>
                                                <td className="p-6 sticky left-0 bg-white shadow-sm z-10">
                                                    <div className="flex items-center gap-2">
                                                        <div className="font-black text-slate-800">{p.code}</div>
                                                        {expired && (
                                                            <div className="w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
                                                        )}
                                                    </div>
                                                    <div className="text-[10px] text-slate-400 font-bold truncate max-w-[200px]">{p.title}</div>
                                                    {expired && <div className="text-[8px] text-red-600 font-black mt-1 uppercase tracking-tighter animate-pulse">Vencimento Detectado</div>}
                                                </td>
                                                {availableRoles.map(role => (
                                                    <td key={role} className="p-4 text-center border-l">
                                                        <button onClick={() => toggleRole(p.id, role)} className={`w-8 h-8 rounded-lg flex items-center justify-center mx-auto transition-all ${p.roles?.includes(role.toUpperCase()) ? 'bg-blue-600 text-white scale-110 shadow-md shadow-blue-200' : 'bg-slate-100 text-slate-300'}`}>
                                                            {p.roles?.includes(role.toUpperCase()) ? <i data-lucide="check" style={{width: 14}}></i> : <i data-lucide="minus" style={{width: 14}}></i>}
                                                        </button>
                                                    </td>
                                                ))}
                                            </tr>
                                        );
                                    })
                                ) : (
                                    matrixData.map(emp => (
                                        <tr key={emp.id} className="border-t hover:bg-slate-50">
                                            <td className="p-6 sticky left-0 bg-white shadow-sm z-10">
                                                <div className="font-black text-slate-700">{emp.name}</div>
                                                <div className="text-[9px] font-bold text-slate-400 uppercase">{emp.role}</div>
                                            </td>
                                            {procedures.map(p => {
                                                const isRequired = p.roles?.includes(emp.role.toUpperCase());
                                                const key = `${user.uid}_${emp.name}_${p.code}`;
                                                const currentStatus = trainingRecords[key]?.status || 'Pendente';
                                                const expired = isExpired(p.homologationDate, p.validityMonths);
                                                
                                                if (!isRequired) {
                                                    return (
                                                        <td key={p.code} className="p-4 border-l text-center">
                                                            <span className="text-[10px] font-black text-slate-300 uppercase italic">N/A</span>
                                                        </td>
                                                    );
                                                }

                                                return (
                                                    <td key={p.code} className="p-4 border-l text-center">
                                                        <select 
                                                            className={`text-[9px] font-black uppercase p-2 border rounded-xl outline-none transition-all cursor-pointer ${getStatusColor(currentStatus, expired)}`} 
                                                            value={currentStatus} 
                                                            onChange={(e) => updateStatus(emp.name, p.code, e.target.value)}
                                                        >
                                                            <option value="Pendente">Pendente</option>
                                                            <option value="Concluído">Concluído</option>
                                                            <option value="Atrasado">Atrasado</option>
                                                        </select>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PdiView = ({ pdis, employees, user }) => {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({ 
                employee: '', 
                careerObjective: '', 
                goals: [], 
                generalComments: '' 
            });
            const [newGoal, setNewGoal] = useState({ text: '', deadline: '' });

            useEffect(() => { lucide.createIcons(); }, [pdis, showForm, formData.goals]);

            const handleSave = async (e) => {
                e.preventDefault();
                if (formData.goals.length === 0) {
                    alert('Adicione pelo menos uma meta ao PDI.');
                    return;
                }
                await db.collection('pdis').add({
                    ...formData,
                    uid: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'Em Curso'
                });
                setFormData({ employee: '', careerObjective: '', goals: [], generalComments: '' });
                setShowForm(false);
            };

            const addGoal = () => {
                if (!newGoal.text || !newGoal.deadline) return;
                setFormData({
                    ...formData,
                    goals: [...formData.goals, { ...newGoal, completed: false, id: Date.now().toString() }]
                });
                setNewGoal({ text: '', deadline: '' });
            };

            const removeGoal = (id) => {
                setFormData({
                    ...formData,
                    goals: formData.goals.filter(g => g.id !== id)
                });
            };

            const toggleGoalStatus = async (pdiId, goalId) => {
                const pdi = pdis.find(p => p.id === pdiId);
                const updatedGoals = pdi.goals.map(g => 
                    g.id === goalId ? { ...g, completed: !g.completed } : g
                );
                await db.collection('pdis').doc(pdiId).update({ goals: updatedGoals });
            };

            const calculateProgress = (goals) => {
                if (!goals || goals.length === 0) return 0;
                const completed = goals.filter(g => g.completed).length;
                return Math.round((completed / goals.length) * 100);
            };

            return (
                <div className="animate-fade">
                    <header className="flex justify-between items-center mb-10">
                        <div>
                            <h2 className="text-3xl font-black text-slate-800 tracking-tight uppercase">Planos PDI</h2>
                            <p className="text-slate-500 font-medium">Gestão individual de desenvolvimento e metas.</p>
                        </div>
                        <button onClick={() => setShowForm(!showForm)} className="bg-blue-600 text-white px-8 py-4 rounded-[1.5rem] font-black uppercase text-xs shadow-lg shadow-blue-100 hover:scale-105 transition-all">
                            {showForm ? 'Fechar Cadastro' : 'Novo PDI'}
                        </button>
                    </header>

                    {showForm && (
                        <form onSubmit={handleSave} className="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-2xl mb-12 space-y-8 animate-fade">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Colaborador</label>
                                    <select required className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold text-slate-700" value={formData.employee} onChange={e => setFormData({...formData, employee: e.target.value})}>
                                        <option value="">Selecionar Colaborador...</option>
                                        {employees.map(e => <option key={e} value={e}>{e}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Objetivo Principal de Carreira</label>
                                    <input required placeholder="Ex: Tornar-se Supervisor de Produção em 2 anos" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-medium" value={formData.careerObjective} onChange={e => setFormData({...formData, careerObjective: e.target.value})} />
                                </div>
                            </div>

                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Registro de Metas de Curto/Médio Prazo</label>
                                <div className="flex flex-col sm:flex-row gap-4">
                                    <input placeholder="Descrição da Meta..." className="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-medium" value={newGoal.text} onChange={e => setNewGoal({...newGoal, text: e.target.value})} />
                                    <input type="date" className="sm:w-48 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-medium" value={newGoal.deadline} onChange={e => setNewGoal({...newGoal, deadline: e.target.value})} />
                                    <button type="button" onClick={addGoal} className="bg-slate-900 text-white px-8 rounded-2xl font-black uppercase text-[10px] hover:bg-slate-800 transition-colors">Adicionar Meta</button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    {formData.goals.map((g, idx) => (
                                        <div key={g.id} className="flex items-center justify-between p-4 bg-blue-50/50 border border-blue-100/50 rounded-2xl">
                                            <div className="flex flex-col">
                                                <span className="text-xs font-black text-blue-900">{g.text}</span>
                                                <span className="text-[9px] font-bold text-blue-400 uppercase tracking-widest">Prazo: {g.deadline}</span>
                                            </div>
                                            <button type="button" onClick={() => removeGoal(g.id)} className="text-red-400 hover:text-red-600 p-2"><i data-lucide="x" style={{width: 14}}></i></button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Observações e Comentários do Gestor</label>
                                <textarea rows={3} placeholder="Registre acordos, pontos de atenção e suportes necessários..." className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-medium" value={formData.generalComments} onChange={e => setFormData({...formData, generalComments: e.target.value})} />
                            </div>

                            <button className="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-black uppercase tracking-widest shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all">Finalizar e Criar PDI Individual</button>
                        </form>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {pdis.map(p => {
                            const progress = calculateProgress(p.goals);
                            return (
                                <div key={p.id} className="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm hover:shadow-xl transition-all group animate-fade flex flex-col h-full">
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="flex items-center gap-4">
                                            <div className="w-14 h-14 bg-slate-900 rounded-3xl flex items-center justify-center text-white font-black text-xl shadow-lg">
                                                {p.employee.charAt(0)}
                                            </div>
                                            <div>
                                                <h4 className="text-xl font-black text-slate-800 tracking-tight">{p.employee}</h4>
                                                <span className="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]">{p.status}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => db.collection('pdis').doc(p.id).delete()} className="text-slate-200 hover:text-red-500 p-2 transition-colors">
                                            <i data-lucide="trash-2" style={{width: 20}}></i>
                                        </button>
                                    </div>

                                    <div className="mb-8 p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
                                        <h5 className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                                            <i data-lucide="target" style={{width: 12}} className="text-blue-500"></i> Objetivo Principal
                                        </h5>
                                        <p className="text-sm font-bold text-slate-700 italic leading-relaxed">"{p.careerObjective}"</p>
                                    </div>

                                    <div className="flex-1 space-y-4 mb-8">
                                        <h5 className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                            <i data-lucide="list-checks" style={{width: 12}} className="text-blue-500"></i> Metas e Acompanhamento
                                        </h5>
                                        <div className="space-y-3">
                                            {(p.goals || []).map(g => (
                                                <div key={g.id} className={`flex items-center gap-4 p-4 rounded-2xl border transition-all ${g.completed ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-slate-100 hover:bg-slate-50'}`}>
                                                    <button onClick={() => toggleGoalStatus(p.id, g.id)} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${g.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-200 text-transparent hover:border-blue-400'}`}>
                                                        <i data-lucide="check" style={{width: 14}}></i>
                                                    </button>
                                                    <div className="flex-1">
                                                        <p className={`text-xs font-bold ${g.completed ? 'text-emerald-700 line-through' : 'text-slate-700'}`}>{g.text}</p>
                                                        <p className="text-[8px] font-black text-slate-400 uppercase mt-1 tracking-widest">Prazo: {g.deadline}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {p.generalComments && (
                                        <div className="mb-8 p-5 bg-amber-50/50 border border-amber-100/50 rounded-2xl">
                                            <p className="text-[10px] text-amber-700 font-medium leading-relaxed">
                                                <span className="font-black uppercase text-[8px] block mb-1">Notas do Gestor:</span>
                                                {p.generalComments}
                                            </p>
                                        </div>
                                    )}

                                    <div className="mt-auto pt-6 border-t border-slate-50">
                                        <div className="flex justify-between items-end mb-3">
                                            <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Aderência ao Plano</span>
                                            <span className={`text-2xl font-black ${progress === 100 ? 'text-emerald-500' : 'text-blue-600'}`}>{progress}%</span>
                                        </div>
                                        <div className="w-full h-4 bg-slate-100 rounded-full overflow-hidden p-1 shadow-inner">
                                            <div className={`h-full rounded-full transition-all duration-700 ${progress === 100 ? 'bg-emerald-500' : 'bg-blue-600 shadow-lg shadow-blue-200'}`} style={{width: `${progress}%`}}></div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const OneOnOneView = ({ meetings, employees, user }) => {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({ employee: '', date: '', summary: '' });

            const save = async (e) => {
                e.preventDefault();
                await db.collection('meetings').add({
                    ...formData,
                    uid: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setFormData({ employee: '', date: '', summary: '' });
                setShowForm(false);
            };

            return (
                <div className="animate-fade">
                    <header className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">Feedbacks 1:1</h2>
                        <button onClick={() => setShowForm(!showForm)} className="bg-blue-600 text-white px-4 py-2 rounded-xl">Nova Reunião</button>
                    </header>
                    {showForm && (
                        <form onSubmit={save} className="bg-white p-6 rounded-[2rem] shadow-xl mb-8 space-y-4">
                            <select className="w-full p-3 border rounded-xl" onChange={e => setFormData({...formData, employee: e.target.value})}>
                                <option value="">Colaborador</option>
                                {employees.map(e => <option key={e} value={e}>{e}</option>)}
                            </select>
                            <input type="date" className="w-full p-3 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                            <textarea className="w-full p-3 border rounded-xl" placeholder="Resumo do feedback..." value={formData.summary} onChange={e => setFormData({...formData, summary: e.target.value})}></textarea>
                            <button className="bg-slate-900 text-white w-full py-3 rounded-xl font-black uppercase">Salvar Feedback</button>
                        </form>
                    )}
                    <div className="space-y-4">
                        {meetings.map(m => (
                            <div key={m.id} className="bg-white p-6 border rounded-[2rem] shadow-sm flex justify-between items-center group">
                                <div>
                                    <h4 className="font-black text-slate-800">{m.employee}</h4>
                                    <p className="text-sm text-slate-500 italic">"{m.summary}"</p>
                                    <p className="text-[10px] text-slate-300 font-bold mt-1 uppercase">{m.date}</p>
                                </div>
                                <button onClick={() => db.collection('meetings').doc(m.id).delete()} className="text-red-200 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-all">
                                    <i data-lucide="trash-2" style={{width: 18}}></i>
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            
            const [matrixData, setMatrixData] = useState([]);
            const [skills, setSkills] = useState([]);
            const [pdis, setPdis] = useState([]);
            const [meetings, setMeetings] = useState([]);
            const [procedures, setProcedures] = useState([]);
            const [trainingRecords, setTrainingRecords] = useState({});

            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(usr => {
                    setUser(usr);
                    setLoading(false);
                });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const filter = ['uid', '==', user.uid];
                const unsubs = [
                    db.collection('operators').where(...filter).onSnapshot(s => setMatrixData(s.docs.map(d => ({...d.data(), id: d.id})))),
                    db.collection('skills_config').where(...filter).onSnapshot(s => setSkills(s.docs.map(d => ({...d.data(), id: d.id})))),
                    db.collection('pdis').where(...filter).onSnapshot(s => setPdis(s.docs.map(d => ({...d.data(), id: d.id})))),
                    db.collection('meetings').where(...filter).onSnapshot(s => setMeetings(s.docs.map(d => ({...d.data(), id: d.id})))),
                    db.collection('procedures').where(...filter).onSnapshot(s => setProcedures(s.docs.map(d => ({...d.data(), id: d.id})))),
                    db.collection('training_records').where(...filter).onSnapshot(s => {
                        const recs = {};
                        s.docs.forEach(d => recs[d.id] = d.data());
                        setTrainingRecords(recs);
                    })
                ];
                return () => unsubs.forEach(u => u());
            }, [user]);

            const employeeNames = useMemo(() => matrixData.map(o => o.name).sort(), [matrixData]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center">
                        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                );
            }

            if (!user) return <AuthView />;

            const menu = [
                { id: 'dashboard', label: 'Home', icon: 'layout-dashboard' },
                { id: 'operators', label: 'Colaboradores', icon: 'user-plus' },
                { id: 'matrix', label: 'Habilidades', icon: 'grid' },
                { id: 'training', label: 'Treinamento', icon: 'graduation-cap' },
                { id: 'pdi', label: 'PDI', icon: 'target' },
                { id: 'oneone', label: '1:1', icon: 'message-square' },
            ];

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-[#f8fafc]">
                    <aside className="hidden md:flex w-72 bg-slate-900 flex-col sticky top-0 h-screen z-50">
                        <div className="p-10 flex flex-col h-full">
                            <div className="flex items-center gap-4 mb-16">
                                <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-xl p-1">
                                    <LogoIcon />
                                </div>
                                <h1 className="text-white text-xs font-black uppercase tracking-widest leading-none">Líder App<br/><span className="text-[8px] text-blue-500 opacity-60 italic tracking-tighter">Método Sistema Líder</span></h1>
                            </div>
                            <nav className="space-y-2 flex-1">
                                {menu.map(item => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all text-left ${activeTab === item.id ? 'bg-blue-600 text-white shadow-xl' : 'text-slate-400 hover:bg-slate-800'}`}>
                                        <i data-lucide={item.icon} style={{width: '20px'}}></i>
                                        <span className="text-[11px] font-black uppercase tracking-widest">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                            <button onClick={() => auth.signOut()} className="mt-auto flex items-center gap-4 px-6 py-4 rounded-2xl text-red-400 hover:bg-red-950/20 transition-all font-black text-[11px] uppercase tracking-widest">
                                <i data-lucide="log-out" style={{width: '20px'}}></i> Sair
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto">
                        <header className="sticky top-0 z-40 px-10 py-6 bg-white/80 backdrop-blur-xl border-b flex justify-between items-center shadow-sm">
                            <div className="flex items-center gap-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <i data-lucide="user" style={{width: 14}} className="text-blue-500"></i> {user.email}
                            </div>
                        </header>
                        <div className="p-6 md:p-12 max-w-7xl mx-auto pb-32">
                            {activeTab === 'dashboard' && <Dashboard matrixData={matrixData} pdis={pdis} meetings={meetings} skills={skills} procedures={procedures} trainingRecords={trainingRecords} />}
                            {activeTab === 'operators' && <OperatorRegistrationView matrixData={matrixData} skills={skills} user={user} />}
                            {activeTab === 'matrix' && <SkillMatrixView data={matrixData} skills={skills} user={user} />}
                            {activeTab === 'training' && <TrainingMatrixView matrixData={matrixData} procedures={procedures} trainingRecords={trainingRecords} user={user} />}
                            {activeTab === 'pdi' && <PdiView pdis={pdis} employees={employeeNames} user={user} />}
                            {activeTab === 'oneone' && <OneOnOneView meetings={meetings} employees={employeeNames} user={user} />}
                        </div>
                    </main>

                    <nav className="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-xl px-8 py-4 rounded-full shadow-2xl flex gap-8 z-50 overflow-x-auto max-w-[90vw] no-scrollbar">
                        {menu.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`p-1 transition-all ${activeTab === item.id ? 'text-blue-500 scale-125' : 'text-slate-500'}`}>
                                <i data-lucide={item.icon} style={{width: '22px'}}></i>
                            </button>
                        ))}
                        <button onClick={() => auth.signOut()} className="p-1 text-red-500"><i data-lucide="log-out" style={{width: '22px'}}></i></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
